---
output: github_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "# "
)
```

[![Build Status](https://travis-ci.org/cstubben/tidypmc.svg?branch=master)](https://travis-ci.org/cstubben/tidypmc)
[![Coverage status](https://codecov.io/gh/cstubben/tidypmc/branch/master/graph/badge.svg)](https://codecov.io/github/cstubben/tidypmc?branch=master)
[![](https://badges.ropensci.org/290_status.svg)](https://github.com/ropensci/software-review/issues/290)

# tidypmc

`tidypmc` parses XML documents in the Open Access subset of [Pubmed Central].  Use `devtools` to install the package.

```{r install, eval=FALSE}
devtools::install_github("cstubben/tidypmc")
```

## Parsing XML

Download the PMC full text using the [europepmc] package.

```{r epmc_ftxt}
library(europepmc)
doc <- epmc_ftxt("PMC2231364")
doc
```

The package includes five functions to parse the `xml_document`.


|R function     |Description                                                                |
|:--------------|:--------------------------------------------------------------------------|
|`pmc_text`     |Split section paragraphs into sentences with full path to subsection titles|
|`pmc_caption`  |Split figure, table and supplementary material captions into sentences     |
|`pmc_table`    |Convert table nodes into a list of tibbles                                 |
|`pmc_reference`|Format references cited into a tibble                                      |
|`pmc_metadata` |List journal and article metadata in front node                            |



The `pmc_text` function uses the [tokenizers] package to split paragraphs into sentences.  The full
path to the subsection title is also included.

```{r pmc_text, echo=-1}
options(width=110)
library(tidypmc)
txt <- pmc_text(doc)
txt
dplyr::count(txt, section)
```


Load the [tidytext] package for further text processing.

```{r tidytext, echo=-1}
options(width=110)
library(tidytext)
library(dplyr)
x1 <- unnest_tokens(txt, word, text) %>%
  anti_join(stop_words) %>%
   filter(!word %in% 1:100)
filter(x1, grepl("^Results", section))
filter(x1, grepl("^Results", section)) %>% dplyr::count(word, sort = TRUE)
```


The `pmc_table` function formats tables by collapsing multiline headers, expanding rowspan and colspan attributes and adding
subheadings into a new column.

```{r pmc_table, echo=-1}
options(width=110)
tbls <- pmc_table(doc)
sapply(tbls, nrow)
tbls[[1]]
```

Use `collapse_rows` to join column names and cell values in a semi-colon delimited string (and
then search using functions in the next section).

```{r collapserows, echo=-1}
options(width=110)
collapse_rows(tbls, na.string="-")
```

## Searching text

There are a few functions to search within the `pmc_text` or collapsed
`pmc_table` output.  `separate_text` uses the [stringr] package to extract any
regular expression or vector of words.


```{r separate_text, echo=-1}
options(width=110)
separate_text(txt, "[ATCGN]{5,}")
```

A few wrappers search pre-defined patterns and add an extra step to expand
matched ranges. `separate_refs` matches references within brackets using
`\\[[0-9, -]+\\]` and expands ranges like `[7-9]`.

```{r separate_refs, echo=-1}
options(width=110)
separate_refs(txt)
```

`separate_genes` will find microbial genes like tauD (with a
capitalized 4th letter)  and expand operons like `tauABCD` into
four genes.  `separate_tags` will find and expand locus tag ranges below.


```{r locus_tags, echo=-1}
options(width=110)
collapse_rows(tbls, na="-") %>% separate_tags("YPO") %>% filter(id =="YPO1855")
```


See the help pages and [vignette] for more details.  A [second vignette]
has details on parsing XML files at the [Europe PMC FTP].

[Europe PMC FTP]: https://europepmc.org/ftp/oa/
[tidytext]: https://www.tidytextmining.com/
[stringr]: https://stringr.tidyverse.org/
[vignette]: https://github.com/cstubben/tidypmc/blob/master/vignettes/tidypmc.md
[second vignette]: https://github.com/cstubben/tidypmc/blob/master/vignettes/pmcftp.md
[tokenizers]: https://lincolnmullen.com/software/tokenizers/
[xml2]: https://github.com/r-lib/xml2
[europepmc]: https://github.com/ropensci/europepmc
[Pubmed Central]: https://europepmc.org
